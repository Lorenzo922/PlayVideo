<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PlayVideos</title>
</head>
<body>
  <!-- LOGIN -->
  <div id="login-area">
    <h1>Login</h1>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Senha"><br>
    <button onclick="login()">Entrar</button>
  </div>

  <!-- PÁGINA PRINCIPAL -->
  <div id="main-area" style="display: none;">
    <h1>Bem-vindo ao PlayVideos!</h1>

    <input type="file" id="videoFile" accept="video/mp4">
    <button onclick="uploadVideo()">Enviar Vídeo</button>

    <h2>Vídeos Enviados:</h2>
    <div id="videoList"></div>
  </div>

  <!-- Firebase + Supabase -->
  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA-PEvp2reLWNxI_HKPMS2vofxSNOvDzDE",
      authDomain: "playvideos-e2d5d.firebaseapp.com",
      projectId: "playvideos-e2d5d",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    window.login = function () {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("Login realizado com sucesso!");
          document.getElementById("login-area").style.display = "none";
          document.getElementById("main-area").style.display = "block";
          loadVideos();
        })
        .catch((error) => {
          alert("Erro no login: " + error.message);
        });
    };

    // Supabase
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabaseUrl = 'https://qnkhbbpfitoiygpkkxii.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFua2hiYnBmaXRvaXlncGtreGlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5NjQ2NDAsImV4cCI6MjA2ODU0MDY0MH0.DJOPPhwycwsUaOStVQcVOsHDTZrXMDjN5KPohUvRkzY';
    const supabase = createClient(supabaseUrl, supabaseKey);

    window.uploadVideo = async function () {
      const fileInput = document.getElementById('videoFile');
      const file = fileInput.files[0];
      if (!file) {
        alert("Escolha um vídeo primeiro.");
        return;
      }

      const { data, error } = await supabase.storage
        .from('videos')
        .upload(`videos/${Date.now()}_${file.name}`, file);

      if (error) {
        alert("Erro ao enviar: " + error.message);
      } else {
        alert("Vídeo enviado com sucesso!");
        loadVideos();
      }
    };

    window.loadVideos = async function () {
      const { data, error } = await supabase.storage
        .from('videos')
        .list('videos', { limit: 100 });

      const container = document.getElementById("videoList");
      container.innerHTML = "";

      if (error) {
        container.innerHTML = "Erro ao carregar vídeos.";
        return;
      }

      for (const file of data) {
        const { data: urlData } = await supabase.storage
          .from('videos')
          .getPublicUrl(`videos/${file.name}`);

        const video = document.createElement("video");
        video.src = urlData.publicUrl;
        video.controls = true;
        video.width = 400;
        container.appendChild(video);
      }
    };

    // Mostrar automaticamente se já está logado
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("login-area").style.display = "none";
        document.getElementById("main-area").style.display = "block";
        loadVideos();
      }
    });
  </script>
</body>
</html>
